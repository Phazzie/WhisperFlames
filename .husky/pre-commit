#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check if any staged files are in src/generated/
staged_generated_files=$(git diff --cached --name-only | grep "^src/generated/")

if [ -n "$staged_generated_files" ]; then
  echo "🚨 Files in src/generated/ are staged for commit:"
  echo "$staged_generated_files"
  echo ""
  
  # Check if commit message contains Manual-Patch trailer
  commit_msg_file=$(git rev-parse --git-dir)/COMMIT_EDITMSG
  
  if [ -f "$commit_msg_file" ]; then
    if ! grep -q "Manual-Patch:\s\+\S\+" "$commit_msg_file"; then
      echo "❌ Commit blocked: Manual edits to src/generated/ require a 'Manual-Patch: <SeamName>' trailer"
      echo ""
      echo "Add this to your commit message:"
      echo "Manual-Patch: YourSeamName"
      echo ""
      exit 1
    fi
  else
    echo "❌ Commit blocked: Manual edits to src/generated/ require a 'Manual-Patch: <SeamName>' trailer"
    echo ""
    echo "Add this to your commit message:"
    echo "Manual-Patch: YourSeamName"
    echo ""
    exit 1
  fi
  
  echo "✅ Manual-Patch trailer found - commit allowed"
fi
